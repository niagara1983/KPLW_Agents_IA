<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√©n√©rateur de R√©ponses RFP KPLW</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #003366 0%, #004d99 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .upload-section {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 60px 40px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s;
            cursor: pointer;
            margin-bottom: 30px;
        }

        .upload-section:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-section.dragover {
            border-color: #5a67d8;
            background: #e6e9ff;
        }

        .upload-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .upload-section h2 {
            font-size: 1.5em;
            margin-bottom: 10px;
            color: #333;
        }

        .upload-section p {
            color: #666;
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333;
        }

        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border 0.3s;
        }

        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .checkbox-group input[type="checkbox"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .file-list {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 10px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .file-item:last-child {
            margin-bottom: 0;
        }

        .file-name {
            font-weight: 500;
            color: #333;
        }

        .file-size {
            color: #666;
            font-size: 0.9em;
        }

        .remove-file {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .remove-file:hover {
            background: #c0392b;
        }

        .progress-section {
            display: none;
            margin-top: 30px;
            padding: 30px;
            background: #f8f9ff;
            border-radius: 10px;
        }

        .progress-section.active {
            display: block;
        }

        .progress-bar-container {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .progress-message {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
        }

        .results-section {
            display: none;
            margin-top: 30px;
            padding: 30px;
            background: #f0fdf4;
            border-radius: 10px;
            border: 2px solid #86efac;
        }

        .results-section.active {
            display: block;
        }

        .results-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .results-header h2 {
            color: #16a34a;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .score-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .score-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .score-card h3 {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .score-card .score {
            font-size: 2.5em;
            font-weight: bold;
            color: #16a34a;
        }

        .download-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .download-btn {
            background: #16a34a;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .download-btn:hover {
            background: #15803d;
            transform: translateY(-2px);
        }

        .new-rfp-btn {
            margin-top: 20px;
            width: 100%;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-section {
            display: none;
            margin-top: 30px;
            padding: 30px;
            background: #fee;
            border-radius: 10px;
            border: 2px solid #fcc;
            color: #c00;
        }

        .error-section.active {
            display: block;
        }

        @media (max-width: 768px) {
            .container {
                border-radius: 0;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ G√©n√©rateur de R√©ponses RFP KPLW</h1>
            <p>G√©n√©ration de R√©ponses RFP par Intelligence Artificielle</p>
            <p style="font-size: 0.9em; margin-top: 10px;">TIMBO ‚Ä¢ ZAT ‚Ä¢ TESS ‚Ä¢ MARY ‚Ä¢ RANA</p>
        </div>

        <div class="content">
            <!-- Upload Section -->
            <div class="upload-section" id="uploadSection">
                <div class="upload-icon">üìÑ</div>
                <h2>T√©l√©verser les Documents RFP</h2>
                <p>Glissez-d√©posez les fichiers ici, ou cliquez pour parcourir</p>
                <p style="font-size: 0.9em; color: #999;">Formats support√©s : PDF, DOCX, MD</p>
                <input type="file" id="fileInput" class="file-input" multiple accept=".pdf,.docx,.md">
                <button class="btn" onclick="document.getElementById('fileInput').click()">
                    S√©lectionner des Fichiers
                </button>
            </div>

            <!-- File List -->
            <div id="fileList" class="file-list" style="display: none;"></div>

            <!-- CV Upload Section (Optional) -->
            <div class="upload-section" id="cvUploadSection" style="display: none; border-color: #10b981; background: #f0fdf4;">
                <div class="upload-icon">üë•</div>
                <h2>T√©l√©verser les CVs de l'√âquipe (Optionnel)</h2>
                <p>Ajoutez les CVs des membres de l'√©quipe pour des profils personnalis√©s</p>
                <p style="font-size: 0.9em; color: #999;">Formats support√©s : PDF, DOCX</p>
                <input type="file" id="cvFileInput" class="file-input" multiple accept=".pdf,.docx">
                <button class="btn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);" onclick="document.getElementById('cvFileInput').click()">
                    S√©lectionner des CVs (Optionnel)
                </button>
            </div>

            <!-- CV File List -->
            <div id="cvFileList" class="file-list" style="display: none; background: #f0fdf4; border: 2px dashed #10b981;"></div>

            <!-- Configuration Form -->
            <div id="configForm" style="display: none;">
                <div class="form-group">
                    <label for="templateSelect">Mod√®le de Proposition</label>
                    <select id="templateSelect">
                        <option value="government_canada">Gouvernement du Canada</option>
                        <option value="corporate">RFP Corporatif</option>
                        <option value="consulting">Services de Conseil</option>
                        <option value="international_development">D√©veloppement International</option>
                        <option value="it_services">Services TI</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Formats de Sortie</label>
                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox" value="md" checked> Markdown
                        </label>
                        <label>
                            <input type="checkbox" value="docx" checked> Word (DOCX)
                        </label>
                        <label>
                            <input type="checkbox" value="pdf"> PDF
                        </label>
                    </div>
                </div>

                <button class="btn" id="processBtn" style="width: 100%; margin-top: 20px;">
                    üöÄ G√©n√©rer la R√©ponse RFP
                </button>
            </div>

            <!-- Progress Section -->
            <div class="progress-section" id="progressSection">
                <h3 style="text-align: center; margin-bottom: 20px;">Traitement du RFP en cours...</h3>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar" style="width: 0%;">0%</div>
                </div>
                <div class="progress-message" id="progressMessage">Initialisation...</div>
                <div class="spinner"></div>
            </div>

            <!-- Results Section -->
            <div class="results-section" id="resultsSection">
                <div class="results-header">
                    <h2>‚úÖ R√©ponse RFP Compl√©t√©e !</h2>
                    <p>Votre proposition a √©t√© g√©n√©r√©e avec succ√®s</p>
                </div>

                <div class="score-cards" id="scoreCards">
                    <!-- Dynamically populated -->
                </div>

                <div class="download-buttons" id="downloadButtons">
                    <!-- Dynamically populated -->
                </div>

                <button class="btn new-rfp-btn" onclick="location.reload()">
                    Nouveau RFP
                </button>
            </div>

            <!-- Error Section -->
            <div class="error-section" id="errorSection">
                <h3 style="margin-bottom: 10px;">‚ùå Erreur</h3>
                <p id="errorMessage"></p>
                <button class="btn" style="margin-top: 20px;" onclick="location.reload()">
                    R√©essayer
                </button>
            </div>
        </div>
    </div>

    <script>
        let selectedFiles = [];
        let selectedCVFiles = [];  // NEW: CV files
        let currentJobId = null;
        let ws = null;

        // File upload handling
        const uploadSection = document.getElementById('uploadSection');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const cvUploadSection = document.getElementById('cvUploadSection');
        const cvFileInput = document.getElementById('cvFileInput');
        const cvFileList = document.getElementById('cvFileList');
        const configForm = document.getElementById('configForm');
        const processBtn = document.getElementById('processBtn');

        // Drag and drop
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        uploadSection.addEventListener('click', (e) => {
            if (e.target.tagName !== 'BUTTON') {
                fileInput.click();
            }
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // CV file input handling
        cvFileInput.addEventListener('change', (e) => {
            handleCVFiles(e.target.files);
        });

        function handleFiles(files) {
            selectedFiles = Array.from(files);
            displayFileList();
            cvUploadSection.style.display = 'block';  // Show CV upload section
            configForm.style.display = 'block';
        }

        function handleCVFiles(files) {
            selectedCVFiles = Array.from(files);
            displayCVFileList();
        }

        function displayFileList() {
            if (selectedFiles.length === 0) {
                fileList.style.display = 'none';
                return;
            }

            fileList.style.display = 'block';
            fileList.innerHTML = '<h3 style="margin-bottom: 15px;">Fichiers S√©lectionn√©s :</h3>';

            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div>
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${formatFileSize(file.size)}</div>
                    </div>
                    <button class="remove-file" onclick="removeFile(${index})">Retirer</button>
                `;
                fileList.appendChild(fileItem);
            });
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            displayFileList();
        }

        function displayCVFileList() {
            if (selectedCVFiles.length === 0) {
                cvFileList.style.display = 'none';
                return;
            }

            cvFileList.style.display = 'block';
            cvFileList.innerHTML = '<h3 style="margin-bottom: 15px; color: #16a34a;">CVs de l\'√âquipe (analys√©s par TESS) :</h3>';

            selectedCVFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div>
                        <div class="file-name">üë§ ${file.name}</div>
                        <div class="file-size">${formatFileSize(file.size)}</div>
                    </div>
                    <button class="remove-file" onclick="removeCVFile(${index})">Retirer</button>
                `;
                cvFileList.appendChild(fileItem);
            });
        }

        function removeCVFile(index) {
            selectedCVFiles.splice(index, 1);
            displayCVFileList();
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Process RFP
        processBtn.addEventListener('click', async () => {
            if (selectedFiles.length === 0) {
                alert('Veuillez s√©lectionner au moins un fichier');
                return;
            }

            // Get selected formats
            const formatCheckboxes = document.querySelectorAll('.checkbox-group input[type="checkbox"]:checked');
            const formats = Array.from(formatCheckboxes).map(cb => cb.value);

            if (formats.length === 0) {
                alert('Veuillez s√©lectionner au moins un format de sortie');
                return;
            }

            // Get template
            const template = document.getElementById('templateSelect').value;

            // Hide upload sections, show progress
            uploadSection.style.display = 'none';
            cvUploadSection.style.display = 'none';
            configForm.style.display = 'none';
            fileList.style.display = 'none';
            cvFileList.style.display = 'none';
            document.getElementById('progressSection').classList.add('active');

            // Upload files and start processing
            try {
                const formData = new FormData();

                // Add RFP files
                selectedFiles.forEach(file => {
                    formData.append('files', file);
                });

                // Add CV files if any
                selectedCVFiles.forEach(file => {
                    formData.append('cv_files', file);
                });

                const response = await fetch(`/api/rfp/upload?template=${template}&output_formats=${formats.join(',')}`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                currentJobId = data.job_id;

                // Connect WebSocket for progress updates
                connectWebSocket(currentJobId);

                // Poll for status
                pollJobStatus(currentJobId);

            } catch (error) {
                showError('√âchec du t√©l√©versement des fichiers : ' + error.message);
            }
        });

        function connectWebSocket(jobId) {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/rfp/${jobId}`;

            ws = new WebSocket(wsUrl);

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                updateProgress(data.progress, data.message);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            // Keep connection alive
            setInterval(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send('ping');
                }
            }, 30000);
        }

        function updateProgress(progress, message) {
            const progressBar = document.getElementById('progressBar');
            const progressMessage = document.getElementById('progressMessage');

            progressBar.style.width = progress + '%';
            progressBar.textContent = progress + '%';
            progressMessage.textContent = message;
        }

        async function pollJobStatus(jobId) {
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/rfp/status/${jobId}`);
                    const data = await response.json();

                    if (data.status === 'completed') {
                        clearInterval(interval);
                        if (ws) ws.close();
                        showResults(data);
                    } else if (data.status === 'failed') {
                        clearInterval(interval);
                        if (ws) ws.close();
                        showError(data.error || 'Processing failed');
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 2000);
        }

        function showResults(jobData) {
            document.getElementById('progressSection').classList.remove('active');
            document.getElementById('resultsSection').classList.add('active');

            const result = jobData.result;

            // Display scores
            const scoreCards = document.getElementById('scoreCards');
            scoreCards.innerHTML = `
                <div class="score-card">
                    <h3>Score de Qualit√©</h3>
                    <div class="score">${result.rana_score}/100</div>
                </div>
                <div class="score-card">
                    <h3>Conformit√©</h3>
                    <div class="score">${result.compliance_score ? result.compliance_score.toFixed(1) : 0}%</div>
                </div>
                <div class="score-card">
                    <h3>It√©rations</h3>
                    <div class="score">${result.iterations}</div>
                </div>
                <div class="score-card">
                    <h3>Statut</h3>
                    <div class="score" style="font-size: 1.5em;">${result.status.toUpperCase()}</div>
                </div>
            `;

            // Display download buttons
            const downloadButtons = document.getElementById('downloadButtons');
            downloadButtons.innerHTML = `
                <a href="/api/rfp/download/${currentJobId}/md" class="download-btn">üìÑ T√©l√©charger Markdown</a>
                <a href="/api/rfp/download/${currentJobId}/docx" class="download-btn">üìù T√©l√©charger DOCX</a>
                <a href="/api/rfp/download/${currentJobId}/compliance" class="download-btn">‚úÖ Matrice de Conformit√©</a>
            `;

            // Add PDF button if available
            if (result.generated_files && result.generated_files.pdf) {
                downloadButtons.innerHTML += `
                    <a href="/api/rfp/download/${currentJobId}/pdf" class="download-btn">üìï T√©l√©charger PDF</a>
                `;
            }
        }

        function showError(message) {
            document.getElementById('progressSection').classList.remove('active');
            document.getElementById('errorSection').classList.add('active');
            document.getElementById('errorMessage').textContent = message;
        }

        // Load templates on page load
        window.addEventListener('load', async () => {
            try {
                const response = await fetch('/api/templates');
                const data = await response.json();

                const select = document.getElementById('templateSelect');
                select.innerHTML = '';

                data.templates.forEach(template => {
                    const option = document.createElement('option');
                    option.value = template.name;
                    option.textContent = template.display_name;
                    option.title = template.description;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load templates:', error);
            }
        });
    </script>
</body>
</html>
